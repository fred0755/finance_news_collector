name: è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip list | grep requests

      - name: è¿è¡Œé‡‡é›†è„šæœ¬
        id: collect
        env:
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          echo "========================================="
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - å½“å‰ç¯å¢ƒ"
          echo "========================================="
          pwd
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          
          echo "========================================="
          echo "ğŸ“ æ£€æŸ¥é‡‡é›†å™¨ç›®å½•"
          echo "========================================="
          if [ -d "src/collectors" ]; then
            echo "âœ… src/collectors ç›®å½•å­˜åœ¨"
            ls -la src/collectors/
          else
            echo "âŒ src/collectors ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo ""
          
          echo "========================================="
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œé‡‡é›†"
          echo "========================================="
          cd src/collectors
          python run_github_action.py
          
          echo ""
          echo "========================================="
          echo "ğŸ“Š æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶"
          echo "========================================="
          cd ../..
          if [ -d "data" ]; then
            echo "âœ… data ç›®å½•å·²åˆ›å»º"
            ls -la data/
            
            if [ -f "data/latest.json" ]; then
              echo "âœ… latest.json å·²ç”Ÿæˆ"
              echo "æ–‡ä»¶å¤§å°: $(wc -c < data/latest.json) å­—èŠ‚"
              echo "å‰200ä¸ªå­—ç¬¦:"
              head -c 200 data/latest.json
              echo ""
            else
              echo "âŒ latest.json æœªç”Ÿæˆ"
            fi
            
            if [ -f "data/today.json" ]; then
              echo "âœ… today.json å·²ç”Ÿæˆ"
            else
              echo "âŒ today.json æœªç”Ÿæˆ"
            fi
            
            if [ -f "data/last_update.txt" ]; then
              echo "âœ… last_update.txt å·²ç”Ÿæˆ"
              echo "æ›´æ–°æ—¶é—´: $(cat data/last_update.txt)"
            else
              echo "âŒ last_update.txt æœªç”Ÿæˆ"
            fi
          else
            echo "âŒ data ç›®å½•ä¸å­˜åœ¨"
          fi
          echo ""
          
          echo "========================================="
          echo "ğŸ“¤ åŒæ­¥åˆ° Gitee"
          echo "========================================="
          if [ -n "$GITEE_USERNAME" ] && [ -n "$GITEE_TOKEN" ]; then
            echo "âœ… Gitee å‡­è¯å·²é…ç½®"
            
            # é…ç½® git
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            
            # æ·»åŠ æ•°æ®æ–‡ä»¶
            git add data/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            if git diff --cached --quiet; then
              echo "â„¹ï¸ æ•°æ®æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
            else
              echo "ğŸ“¦ æäº¤æ•°æ®æ›´æ–°..."
              git commit -m "chore: è‡ªåŠ¨æ›´æ–°è´¢ç»æ–°é—»æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
              
              echo "ğŸš€ æ¨é€åˆ° Gitee..."
              git push https://$GITEE_USERNAME:$GITEE_TOKEN@gitee.com/$GITEE_USERNAME/finance_news_collector.git main
              echo "âœ… åŒæ­¥å®Œæˆ"
            fi
          else
            echo "âš ï¸ Gitee å‡­è¯æœªé…ç½®ï¼Œè·³è¿‡åŒæ­¥"
            echo "GITEE_USERNAME: ${GITEE_USERNAME:-æœªè®¾ç½®}"
            echo "GITEE_TOKEN: ${GITEE_TOKEN:+å·²è®¾ç½®é•¿åº¦${#GITEE_TOKEN}}"
          fi
          
          echo ""
          echo "========================================="
          echo "ğŸ‰ é‡‡é›†æµç¨‹å®Œæˆ"
          echo "========================================="

      - name: é’‰é’‰çŠ¶æ€é€šçŸ¥
        if: always()
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          if [ -z "$DINGTALK_WEBHOOK" ]; then
            echo "âš ï¸ é’‰é’‰ Webhook æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          STATUS="${{ job.status }}"
          TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "$STATUS" = "success" ]; then
            MSG="âœ… è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†æˆåŠŸ"
            COLOR="00FF00"
            
            # å°è¯•è·å–æ–°é—»æ•°é‡
            if [ -f "data/latest.json" ]; then
              COUNT=$(grep -o '"title"' data/latest.json | wc -l)
              MSG="$MSGï¼Œä»Šæ—¥å·²é‡‡é›† $COUNT æ¡æ–°é—»"
            fi
          else
            MSG="âŒ è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†å¤±è´¥"
            COLOR="FF0000"
          fi
          
          MSG="$MSG\nğŸ• $TIME"
          
          curl -s -X POST "$DINGTALK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"è´¢ç»æ–°é—»é‡‡é›†çŠ¶æ€\",
                \"text\": \"### ğŸ“Š è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†\\n\\n$MSG\\n\\n[æŸ¥çœ‹æ•°æ®](https://gitee.com/${GITEE_USERNAME:-your-username}/finance_news_collector/tree/main/data)\"
              }
            }"
          
          echo "ğŸ“¨ é’‰é’‰é€šçŸ¥å·²å‘é€"