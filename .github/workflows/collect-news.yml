name: è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip list | grep requests

      - name: è¿è¡Œé‡‡é›†è„šæœ¬
        id: collect
        env:
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          # ... å‰é¢çš„æ‰€æœ‰è°ƒè¯•ä»£ç ä¿æŒä¸å˜ ...
          
          echo "========================================="
          echo "ğŸ“¤ åŒæ­¥åˆ° Gitee"
          echo "========================================="
          if [ -n "$GITEE_USERNAME" ] && [ -n "$GITEE_TOKEN" ]; then
            echo "âœ… Gitee å‡­è¯å·²é…ç½®"
            
            # é…ç½® git
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            
            # ğŸš¨ğŸš¨ğŸš¨ å…³é”®ä¿®å¤ï¼šå–æ¶ˆæµ…å…‹éš† ğŸš¨ğŸš¨ğŸš¨
            git fetch --unshallow origin || true
            
            # æ·»åŠ æ•°æ®æ–‡ä»¶
            git add data/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            if git diff --cached --quiet; then
              echo "â„¹ï¸ æ•°æ®æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
            else
              echo "ğŸ“¦ æäº¤æ•°æ®æ›´æ–°..."
              git commit -m "chore: è‡ªåŠ¨æ›´æ–°è´¢ç»æ–°é—»æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
              
              echo "ğŸš€ æ¨é€åˆ° Gitee..."
              git push https://$GITEE_USERNAME:$GITEE_TOKEN@gitee.com/$GITEE_USERNAME/finance_news_collector.git main
              echo "âœ… åŒæ­¥å®Œæˆ"
            fi
          else
            echo "âš ï¸ Gitee å‡­è¯æœªé…ç½®ï¼Œè·³è¿‡åŒæ­¥"
          fi
          
          echo ""
          echo "========================================="
          echo "ğŸ‰ é‡‡é›†æµç¨‹å®Œæˆ"
          echo "========================================="

      - name: é’‰é’‰çŠ¶æ€é€šçŸ¥
        if: always()
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          if [ -z "$DINGTALK_WEBHOOK" ]; then
            echo "âš ï¸ é’‰é’‰ Webhook æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          STATUS="${{ job.status }}"
          TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "$STATUS" = "success" ]; then
            MSG="âœ… è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†æˆåŠŸ"
            COLOR="00FF00"
            
            # å°è¯•è·å–æ–°é—»æ•°é‡
            if [ -f "data/latest.json" ]; then
              COUNT=$(grep -o '"title"' data/latest.json | wc -l)
              MSG="$MSGï¼Œä»Šæ—¥å·²é‡‡é›† $COUNT æ¡æ–°é—»"
            fi
          else
            MSG="âŒ è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†å¤±è´¥"
            COLOR="FF0000"
          fi
          
          MSG="$MSG\nğŸ• $TIME"
          
          curl -s -X POST "$DINGTALK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"è´¢ç»æ–°é—»é‡‡é›†çŠ¶æ€\",
                \"text\": \"### ğŸ“Š è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†\\n\\n$MSG\\n\\n[æŸ¥çœ‹æ•°æ®](https://gitee.com/${GITEE_USERNAME:-your-username}/finance_news_collector/tree/main/data)\"
              }
            }"
          
          echo "ğŸ“¨ é’‰é’‰é€šçŸ¥å·²å‘é€"