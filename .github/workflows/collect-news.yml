name: è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†

on:
  schedule:
    - cron: '*/30 * * * *'   # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆä¸ä½ æœ¬åœ°è°ƒåº¦å™¨ä¸€è‡´ï¼‰
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'src/collectors/**'
      - 'src/processors/**'
      - 'requirements.txt'

jobs:
  collect-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: 2. è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: 3. å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
        # ä½ çš„é¡¹ç›®ä¾èµ–ï¼ˆæ ¹æ®å®é™…requirements.txtè°ƒæ•´ï¼‰
        pip install requests beautifulsoup4 apscheduler

    - name: 4. è¿è¡Œä¸œæ–¹è´¢å¯Œé‡‡é›†å™¨
      id: collect
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        cd src/collectors
        
        # åˆ›å»ºæ•°æ®ç›®å½•
        mkdir -p ../../data
        
        # è¿è¡Œé‡‡é›†å™¨å¹¶ä¿å­˜ä¸ºJSON
        python -c "
import json, sys
from eastmoney_collector import EastMoneyCollector

print('å¼€å§‹é‡‡é›†ä¸œæ–¹è´¢å¯Œå¿«è®¯...')
collector = EastMoneyCollector()
news_list = collector.fetch_news(page_size=30)

if news_list and len(news_list) > 0:
    print(f'âœ… æˆåŠŸé‡‡é›† {len(news_list)} æ¡æ–°é—»')

    # ä¿å­˜ä¸ºlatest.jsonï¼ˆæœ€æ–°50æ¡ï¼‰
    with open('../../data/latest.json', 'w', encoding='utf-8') as f:
        json.dump(news_list[:50], f, ensure_ascii=False, indent=2)

    # ä¿å­˜ä¸ºtoday.jsonï¼ˆä»Šæ—¥æ‰€æœ‰ï¼Œæš‚ä¸ºæœ€æ–°é‡‡é›†ï¼‰
    with open('../../data/today.json', 'w', encoding='utf-8') as f:
        json.dump(news_list, f, ensure_ascii=False, indent=2)

    # ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶
    from datetime import datetime
    with open('../../data/last_update.txt', 'w', encoding='utf-8') as f:
        f.write(datetime.now().strftime('%Y-%m-%d %H:%M:%S'))

    print('âœ… JSONæ–‡ä»¶ç”ŸæˆæˆåŠŸ')
    sys.exit(0)
else:
    print('âŒ é‡‡é›†å¤±è´¥æˆ–æœªè·å–åˆ°æ–°é—»')
    sys.exit(1)
        "
        
    - name: 5. æäº¤æ•°æ®åˆ°Gitee
      env:
        GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
      run: |
        # é…ç½®git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # åªæ·»åŠ dataç›®å½•
        git add data/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --cached --quiet; then
          echo "æ•°æ®æ— æ›´æ–°ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "chore: è‡ªåŠ¨æ›´æ–°è´¢ç»æ–°é—»æ•°æ® $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€åˆ°Gitee
          git push https://$GITEE_USERNAME:$GITEE_TOKEN@gitee.com/$GITEE_USERNAME/finance_news_collector.git main
          echo "âœ… å·²åŒæ­¥åˆ°Gitee"
        fi

    - name: 6. å‘é€é’‰é’‰è¿è¡ŒçŠ¶æ€é€šçŸ¥
      if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½é€šçŸ¥
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        cd src/notifiers
        
        # ç®€æ˜“é’‰é’‰é€šçŸ¥ï¼ˆå¦‚æœæ²¡æœ‰ç°æˆè„šæœ¬ï¼Œç”¨è¿™ä¸ªï¼‰
        if [ "${{ job.status }}" = "success" ]; then
          STATUS="âœ… é‡‡é›†æˆåŠŸ"
          COLOR="00FF00"
        else
          STATUS="âŒ é‡‡é›†å¤±è´¥"
          COLOR="FF0000"
        fi
        
        TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        curl -s -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"msgtype\": \"markdown\",
            \"markdown\": {
              \"title\": \"è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†çŠ¶æ€\",
              \"text\": \"### ğŸ“Š è´¢ç»æ–°é—»äº‘ç«¯é‡‡é›†çŠ¶æ€\\n\\n**çŠ¶æ€**: $STATUS\\n\\n**æ—¶é—´**: $TIME\\n\\n**è¿è¡Œç¯å¢ƒ**: GitHub Actions\\n\\n[æŸ¥çœ‹æ•°æ®](https://gitee.com/${{ secrets.GITEE_USERNAME }}/finance_news_collector/tree/main/data)\"
            }
          }"
        echo "ğŸ“¨ é’‰é’‰çŠ¶æ€é€šçŸ¥å·²å‘é€"